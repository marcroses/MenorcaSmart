$(document).ready(function(){$.mobile.changePage('#mainContainer');setTimeout(fixContentHeight,1000);console.log("--> transparencySliders = "+transparencySliders);if(transparencySliders){$(".carto-slider-transparency").slider({highlight:true,stop:function(ev,ui){var cartoId=$(this).attr("cartoid");var opacity=$(this).val()/100;var transparency=100-$(this).val();console.log("\t --> cartoid ["+cartoId+"]: opacity = "+opacity+", transparency = "+transparency);var layer=map.getLayersByName(cartoId)[0];if(layer!=null)layer.setOpacity(opacity);var carto=getCartografiaByCodigo(cartoId);if(carto!=null)carto.carTransp=transparency;}});}});$(window).bind("orientationchange resize",fixContentHeight);function fixContentHeight(){var header=$("div[data-role='header']:visible"),footer=$("div[data-role='footer']:visible"),content=$("div[data-role='content']:visible:visible"),viewHeight=$(window).height(),contentHeight=viewHeight-footer.outerHeight()-header.outerHeight();console.log("viewHeight:"+viewHeight+" contentHeight:"+contentHeight);if((content.outerHeight()+footer.outerHeight()+header.outerHeight())!==viewHeight){contentHeight-=(content.outerHeight()-content.height()+1);console.log("new contentHeight:"+contentHeight);content.height(contentHeight);}
console.log("lanzamos evento personalizado 'resizeContentHeight' para adaptar las medidad de los contenidos que lo necesiten.");var medidas=getMedidas();$(document).trigger("resizeContentHeight",medidas);if(window.map&&window.map instanceof OpenLayers.Map){map.updateSize();}else{mapInit();}}
function getMedidas(){var header=$("div[data-role='header']:visible"),footer=$("div[data-role='footer']:visible"),viewHeight=$(window).height(),contentHeight=viewHeight-footer.outerHeight()-header.outerHeight();var medidas={viewHeight:viewHeight,contentHeight:contentHeight,footerHeight:footer.outerHeight(),headerHeight:header.outerHeight(),footerWidth:footer.outerWidth(),headerWidth:header.outerWidth()};if(!footer.outerHeight())medidas["footerHeight"]=0;if(!header.outerHeight())medidas["headerHeight"]=0;if(!footer.outerWidth())medidas["footerWidth"]=0;if(!header.outerWidth())medidas["headerWidth"]=0;return medidas;}
function deb(){fixContentHeight();}
function consoleObj(){this.log=function(v){$("#debres").html($("#debres").html()+"<br/>"+v);};this.clear=function(){$("#debres").html("");};}
if(!console){console=new consoleObj();console.clear();}
var getFeatureInfoLayer=null;function mapInit(){try{console.log("mapInit");var olConfig=config.olConfig;map=new OpenLayers.Map('mapa',{theme:null,controls:[new OpenLayers.Control.TouchNavigation({dragPanOptions:{enableKinetic:true}}),new OpenLayers.Control.Zoom({zoomInText:"",zoomOutText:""})],});getFeatureInfoLayer=new OpenLayers.Control.NGWMSGetFeatureInfo({title:'Identify',queryVisible:true,drillDown:false,infoFormat:"text/xml",eventListeners:asignarListener(),serviceInfoURL:getServiceInfoURL()});map.addControl(getFeatureInfoLayer);setMapConfig(olConfig,map);setMapLayers(olConfig,map);try{if(debugOn){var ls=new OpenLayers.Control.LayerSwitcher();map.addControl(ls);ls.maximizeControl();}}catch(e){console.warn("Error añadiendo LayerSwitcher");}
addGeolocateControl();try{if(wktInit!=null){map.zoomToExtent(OpenLayers.Geometry.fromWKT(wktInit).getBounds());}else if(scaleInit!=null){map.zoomToScale(parseFloat(scaleInit),true);}else if(bboxInit!=null){map.zoomToExtent(OpenLayers.Bounds.fromString(bboxInit),true);}else map.zoomToMaxExtent();}catch(e){console.warn("Error inicializando extensión inicial.",e);map.zoomToMaxExtent();}
$(document).trigger("openLayerMap_loaded");}catch(e){console.error("Error inicializando mapa: ",e);}}
function addGeolocateControl(){try{var vector=new OpenLayers.Layer.Vector('geolocateVector');map.addLayers([vector]);var pulsate=function(feature){var point=feature.geometry.getCentroid(),bounds=feature.geometry.getBounds(),radius=Math.abs((bounds.right-bounds.left)/2),count=0,grow='up';var resize=function(){if(count>16){clearInterval(window.resizeInterval);}
var interval=radius*0.03;var ratio=interval/radius;switch(count){case 4:case 12:grow='down';break;case 8:grow='up';break;}
if(grow!=='up'){ratio=-Math.abs(ratio);}
feature.geometry.resize(1+ratio,point);vector.drawFeature(feature);count++;};window.resizeInterval=window.setInterval(resize,50,point,radius);};var geolocate=new OpenLayers.Control.Geolocate({bind:false,geolocationOptions:{enableHighAccuracy:false,maximumAge:0,timeout:7000}});map.addControl(geolocate);geolocate.events.register("locationupdated",geolocate,function(e){console.log("geolocate locationupdated",e);$.mobile.hidePageLoadingMsg('Searching');vector.removeAllFeatures();if(!map.getMaxExtent().containsLonLat(new OpenLayers.LonLat(e.point.x,e.point.y))){alert(nls.MA_GEOLOCATE_LIMITES);return;}
var circle=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(e.point.x,e.point.y),e.position.coords.accuracy/2,40,0),{},{fillColor:'#000',fillOpacity:0.1,strokeWidth:0});vector.addFeatures([new OpenLayers.Feature.Vector(e.point,{},{externalGraphic:"img/mobile-loc.png",graphicOpacity:1.0,graphicWidth:16,graphicHeight:26,graphicYOffset:-26}),circle]);try{escala=parseFloat(sitmunProperties["reneix.escalaGeoLocalizacion"]);}catch(e){console.error("Falta definir una escala",e);}
console.log("\t escala: ",escala);if(escala>0)map.zoomToScale(escala,true);map.setCenter(vector.getDataExtent().getCenterLonLat());pulsate(circle);});geolocate.events.register("locationfailed",this,function(){$.mobile.hidePageLoadingMsg('Searching');OpenLayers.Console.log('Location detection failed');});}catch(e){console.error("Error en addGeolocateControl: ",e);}}
var timer_geolocate;function initGeolocate(){clearTimeout(timer_geolocate);timer_geolocate=setTimeout(function(){doGeolocate();},1000);}
function doGeolocate(){$.mobile.showPageLoadingMsg('Searching');var vector=map.getLayersByName("geolocateVector")[0];var geolocate=map.getControlsByClass("OpenLayers.Control.Geolocate")[0];vector.removeAllFeatures();geolocate.deactivate();geolocate.watch=false;geolocate.activate();}
function maxExtensionMap(){map.zoomToMaxExtent();}
function setMapConfig(olConfig,map){if(olConfig.projection!=null&&olConfig.projection.length>0){map.projection=olConfig.projection;}
if(olConfig.units!=null&&olConfig.units.length>0){map.units=olConfig.units;}
if(olConfig.tilesizeX!=null&&olConfig.tilesizeY!=null){map.tileSize=new OpenLayers.Size(olConfig.tilesizeX,olConfig.tilesizeY);}
if(olConfig.extensionMaximaXMin>0&&olConfig.extensionMaximaXMax>0&&olConfig.extensionMaximaYMin>0&&olConfig.extensionMaximaYMax>0){var b=new OpenLayers.Bounds(olConfig.extensionMaximaXMin,olConfig.extensionMaximaYMin,olConfig.extensionMaximaXMax,olConfig.extensionMaximaYMax);map.maxExtent=b;}else{console.error("Territorio sin extensión máxima definida. Revisa la configuración del territorio.");map.maxExtent=new OpenLayers.Bounds(250425,4506575,580700,4677900);}
if(olConfig.extensionRestringidaXMin>0&&olConfig.extensionRestringidaXMax>0&&olConfig.extensionRestringidaYMin>0&&olConfig.extensionRestringidaYMax>0){var b=new OpenLayers.Bounds(olConfig.extensionRestringidaXMin,olConfig.extensionRestringidaYMin,olConfig.extensionRestringidaXMax,olConfig.extensionRestringidaYMax);map.restrictedExtent=b;}
if(olConfig.scales!=null&&olConfig.scales.length>0){var limitScaleByTerritorio=sitmunProperties["mapa.lista.escalas"]&&sitmunProperties["mapa.lista.escalas"]=="territorio";var resArray=new Array();for(var nesc=olConfig.scales.length-1;nesc>=0;nesc--){var res;if(typeof(olConfig.resolutions)!="undefined"&&olConfig.resolutions!==null&&olConfig.resolutions.length>0)res=olConfig.resolutions[nesc];else res=OpenLayers.Util.getResolutionFromScale(olConfig.scales[nesc],map.units);resArray.push(res);}
map.resolutions=resArray.reverse();}}
var layerCenter=null;function addMarkerCenter(functionIni,functionEvent){var center=map.getCenter();layerCenter=new OpenLayers.Layer.Markers("center_marker");layerCenter.setVisibility(false);map.addLayer(layerCenter);var size=new OpenLayers.Size(30,30);var offset=new OpenLayers.Pixel(-(size.w/2),-size.h);var icon=new OpenLayers.Icon('img/locate-high.png',size,offset);layerCenter.addMarker(new OpenLayers.Marker(center,icon));functionIni();map.events.register("moveend",map,function(e){layerCenter.clearMarkers();layerCenter.addMarker(new OpenLayers.Marker(map.getCenter(),icon));functionEvent();});}
function setMapLayers(olConfig,map){try{var fondoCartoIds=new Array();for(var i=0;i<olConfig.cartografiaFondo.length;i++){fondoCartoIds=fondoCartoIds.concat(olConfig.cartografiaFondo[i].cartoCodigos);}
var numberOfLayers=olConfig.cartografias.length;var base=new OpenLayers.Layer("dummy",{isBaseLayer:true});map.addLayer(base);for(var i=0;i<numberOfLayers;i++){var cartografia=olConfig.cartografias[i];var isFondo=fondoCartoIds.indexOf(cartografia.carCodigo)>-1;if(cartografia.carVisible==1||isFondo){var layer=createLayerOL(cartografia,isFondo);}}}catch(e){console.error("Error a setMapLayers()",e);}}
function createLayerOL(cartografia,isFondo,addToMap){try{if(typeof(isFondo)=="undefined")isFondo=false;if(typeof(addToMap)=="undefined")addToMap=true;var layers=map.getLayersByName(cartografia.carCodigo);if(addToMap&&layers.length>0){console.info("createLayerOL: El layer ya existe en OL. carCodigo='"+cartografia.carCodigo+"'");return layers[0];}
var service=cartografia.stmServicio;var serTipo=cartografia.stmServicio.serTipo;if(serTipo=="TC"||serTipo=="TILECACHE"||serTipo=="ARCGISSERVER")serTipo="WMS";var serviceUrlParams=getParamsObj(service.stmParamsers,serTipo);var serviceLayerParams=getParamsObj(service.stmParamsers,"OLPARAM");var otherParams={visibility:cartografia.carVisible==1,singleTile:true,ratio:1,transitionEffect:(isFondo==true)?"resize":"",opacity:1-cartografia.carTransp/100,displayOutsideMaxExtent:true,order:cartografia.carOrden,isBaseLayer:false,carCodigo:(isFinite(cartografia.carCodigo))?cartografia.carCodigo:null,projection:service.serProjects,tematico:(cartografia.tematico)?true:false,tematicoUrl:(cartografia.tematico)?service.serUrl:"",esQueryable:cartografia.carQueryabl,capasQueryable:cartografia.carQuerylay,urlQueryable:cartografia.stmServicio.serInfourl?cartografia.stmServicio.serInfourl:cartografia.stmServicio.serUrl};var minScaleOn=false;if(cartografia.carEscMin!==null&&!isNaN(parseFloat(cartografia.carEscMin))){otherParams.minResolution=OpenLayers.Util.getResolutionFromScale(parseFloat(cartografia.carEscMin),map.units);otherParams.alwaysInRange=false;minScaleOn=true;}
if(cartografia.carEscMax!==null&&!isNaN(parseFloat(cartografia.carEscMax))&&cartografia.carEscMax>0){otherParams.maxResolution=OpenLayers.Util.getResolutionFromScale(parseFloat(cartografia.carEscMax),map.units);otherParams.alwaysInRange=false;}else if(minScaleOn){otherParams.maxResolution=map.getMaxResolution();}
for(param in serviceLayerParams)otherParams[param]=(serviceLayerParams[param]==null)?'':serviceLayerParams[param];var needsAuth=sitmunProperties["proxy.serverurl"]!=null&&service.serUrl.indexOf(sitmunProperties["proxy.serverurl"])>-1||service.serAuth;var i=1;while(sitmunProperties["proxy.wms."+i+".serverurl"]!=null){if(service.serUrl.indexOf(sitmunProperties["proxy.wms."+i+".serverurl"])>0){needsAuth=true;break;}
i++;}
var j=1;while(sitmunProperties["proxy.wfs."+j+".serverurl"]!=null){if(service.serUrl.indexOf(sitmunProperties["proxy.wfs."+j+".serverurl"])>0){needsAuth=true;break;}
j++;}
var url=(proxyOn&&needsAuth)?urlProxy+escape(service.serUrl):service.serUrl;if(window["createLayer"+service.serTipo.toUpperCase()]){var func=eval("createLayer"+service.serTipo.toUpperCase());if(func==null||typeof(func)!="function"){console.error("Cartografia con tipo desconocido. carto:'"+cartografia.carCodigo+"' tipo:'"+service.serTipo+"'");}else{var layer=func(cartografia.carCodigo,replaceSessionParams(url),cartografia.carCapas,serviceUrlParams,otherParams,cartografia,addToMap);if(layer!=null){layer.carNombre=cartografia.carNombre;layer.order=cartografia.carOrden;if(cartografia.carTransp!=null)layer.setOpacity((100-cartografia.carTransp)/100);if(addToMap){map.addLayer(layer);raiseLayerOrder(layer);}
if(layer.CLASS_NAME=="OpenLayers.Layer.Vector"){layer.redraw();}}}
return layer;}else{alert("Error: Capa con un tipo no soportado: "+service.serTipo.toUpperCase());return null;}}catch(e){console.error("Error a createLayerOL()",e);return null;}}
function getParamsObj(paramsArray,tipoFilter){var ret=new Object();for(var i=0;i<paramsArray.length;i++){var item=paramsArray[i];if(tipoFilter==null||item.id.pseTipo.toLowerCase()==tipoFilter.toLowerCase()){var obj=new Object();ret[item.id.pseNombre]=item.pseValor;}}
return ret;}
function replaceSessionParams(inputString){try{console.warn("replaceSessionParams: METODE A IMPLEMENTAR EN JQUERY");return inputString;}catch(e){console.log("Error en replaceSessionParams()",e.message);}}
function raiseLayerOrder(layer){var overlayLayers=map.layers;var len=overlayLayers.length;if(len>1){var i=len-2;var delta=0;var currentOrder=overlayLayers[len-1].order;if(typeof(currentOrder)=="undefined")console.error("Error aplicando ordenacion en raiseLayerOrder();");while(i>=0&&(typeof(overlayLayers[i].order)=="undefined"||currentOrder<overlayLayers[i].order)){i--;delta++;}
if(delta>0)map.raiseLayer(layer,-delta);}}
function layerChanged(cartoid,elem){console.log(cartoid,$(elem));var type=$(elem).attr("type");var checked=elem.checked;console.log("type: "+type+" visibility: ",checked);if(type=="checkbox"){mapChangeVisibility(null,cartoid,checked);}else if(type=="radio"){var radioName=$(elem).attr("name");$(".layersradio").each(function(){mapChangeVisibility(null,$(this).val(),false);});mapChangeVisibility(null,cartoid,true);}}
function mapChangeVisibility(id,cartoid,visibility){console.log("> mapChangeVisibility cartoid: "+cartoid+" visibility: "+visibility);try{if(cartoid==0)return;var cartografia=getCartografiaByCodigo(cartoid);var layers=map.getLayersByName(cartoid);if(cartografia==null)console.warn("mapChangeVisibility: Cartografia no encontrada para el id="+cartoid);cartografia.carVisible=visibility;if(visibility){if(layers.length>0){console.warn("Intentando hacer visible un layer existente. Es normal si tiene el info activo.");layers[0].setVisibility(visibility);if(cartografia.carTransp!=null)layers[0].setOpacity((100-cartografia.carTransp)/100);}else{console.log("mapChangeVisibility carto ",cartografia);createLayerOL(cartografia);}}else{if(layers.length>0){layers[0].destroy();}}}catch(e){console.error(e);}}
function getCartografiaByCodigo(codigo){var found=false;var i=0;while(!found&&i<config.olConfig.cartografias.length){if(config.olConfig.cartografias[i].carCodigo==codigo)found=true;else i++;}
if(found)return config.olConfig.cartografias[i];else return null;}
function addMarker(the_geom){try{if(!the_geom)return;var wkt=new OpenLayers.Format.WKT();var features=wkt.read(the_geom);$.mobile.changePage('#mainContainer');var localizadorLayer=getLayerBuscador();localizadorLayer.addFeatures(features);escala=parseFloat(sitmunProperties["reneix.escalaCandidato"]);console.log("\t escala: ",escala);if(escala>0)map.zoomToScale(escala,true);map.setCenter(features.geometry.getBounds().getCenterLonLat());}catch(e){console.error("Error en addMarker",e);}}
function getLayerBuscador(){if(map.getLayersByName("buscador").length==0){var layerOptions={displayInLayerSwitcher:true,styleMap:new OpenLayers.StyleMap({externalGraphic:"img/mobile-loc.png",graphicOpacity:1.0,graphicWidth:16,graphicHeight:26,graphicYOffset:-26,fillColor:"green",fillOpacity:1,strokeColor:"black"})};var localizadorLayer=new OpenLayers.Layer.Vector("buscador",layerOptions);map.addLayer(localizadorLayer);return localizadorLayer;}else{var localizadorLayer=map.getLayersByName("buscador")[0];localizadorLayer.removeAllFeatures();return localizadorLayer;}}
function getSessionObject(){try{var obj=new Object();obj.MUN_INE=config.territorioCodigo;obj.EXTENSION_MAX_X0=config.olConfig.extensionMaximaXMin;obj.EXTENSION_MAX_Y0=config.olConfig.extensionMaximaYMin;obj.EXTENSION_MAX_X1=config.olConfig.extensionMaximaXMax;obj.EXTENSION_MAX_Y1=config.olConfig.extensionMaximaYMax;obj.APP_CODIGO=config.aplicacionId;obj.TER_CODIGO=config.territorioId;obj.USU_CODIGO=config.usuarioId;obj.PROYECCION=config.olConfig.projection;obj.LANG=OpenLayers.Lang.getCode();obj.DATE=new Date().format("d/m/Y H:i:s");obj.USUARIO=config.usuario;try{obj.CENTRO=map.getCenter().toShortString();obj.EXTENSION=map.getExtent().toBBOX();obj.ESCALA=Math.round(map.getScale());obj.CENTRO_X=map.getCenter().lon;obj.CENTRO_Y=map.getCenter().lat;}catch(e){}
if(config.territorioCodigosIne)obj.MUN_INES=config.territorioCodigosIne.join(",");else obj.MUN_INES=null;return obj;}catch(e){console.error("Error a getSessionObject()",e);}}
Date.prototype.format=function(format){var returnStr='';var replace=Date.replaceChars;for(var i=0;i<format.length;i++){var curChar=format.charAt(i);if(replace[curChar]){returnStr+=replace[curChar].call(this);}else{returnStr+=curChar;}}
return returnStr;};Date.replaceChars={shortMonths:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],longMonths:['January','February','March','April','May','June','July','August','September','October','November','December'],shortDays:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],longDays:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],d:function(){return(this.getDate()<10?'0':'')+this.getDate();},D:function(){return Date.replaceChars.shortDays[this.getDay()];},j:function(){return this.getDate();},l:function(){return Date.replaceChars.longDays[this.getDay()];},N:function(){return this.getDay()+1;},S:function(){return(this.getDate()%10==1&&this.getDate()!=11?'st':(this.getDate()%10==2&&this.getDate()!=12?'nd':(this.getDate()%10==3&&this.getDate()!=13?'rd':'th')));},w:function(){return this.getDay();},z:function(){return"Not Yet Supported";},W:function(){return"Not Yet Supported";},F:function(){return Date.replaceChars.longMonths[this.getMonth()];},m:function(){return(this.getMonth()<9?'0':'')+(this.getMonth()+1);},M:function(){return Date.replaceChars.shortMonths[this.getMonth()];},n:function(){return this.getMonth()+1;},t:function(){return"Not Yet Supported";},L:function(){return(((this.getFullYear()%4==0)&&(this.getFullYear()%100!=0))||(this.getFullYear()%400==0))?'1':'0';},o:function(){return"Not Supported";},Y:function(){return this.getFullYear();},y:function(){return(''+this.getFullYear()).substr(2);},a:function(){return this.getHours()<12?'am':'pm';},A:function(){return this.getHours()<12?'AM':'PM';},B:function(){return"Not Yet Supported";},g:function(){return this.getHours()%12||12;},G:function(){return this.getHours();},h:function(){return((this.getHours()%12||12)<10?'0':'')+(this.getHours()%12||12);},H:function(){return(this.getHours()<10?'0':'')+this.getHours();},i:function(){return(this.getMinutes()<10?'0':'')+this.getMinutes();},s:function(){return(this.getSeconds()<10?'0':'')+this.getSeconds();},e:function(){return"Not Yet Supported";},I:function(){return"Not Supported";},O:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+'00';},P:function(){return(-this.getTimezoneOffset()<0?'-':'+')+(Math.abs(this.getTimezoneOffset()/60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()/60))+':'+(Math.abs(this.getTimezoneOffset()%60)<10?'0':'')+(Math.abs(this.getTimezoneOffset()%60));},T:function(){var m=this.getMonth();this.setMonth(0);var result=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,'$1');this.setMonth(m);return result;},Z:function(){return-this.getTimezoneOffset()*60;},c:function(){return this.format("Y-m-d")+"T"+this.format("H:i:sP");},r:function(){return this.toString();},U:function(){return this.getTime()/1000;}};function cerrarMenuMobil(btnId){var btn=$('#'+btnId);if(btn.attr("status")=="open")btn.click();}
function tareasInit(){try{if(typeof(tareas)!="undefined"){for(var i=0;i<tareas.length;i++){try{var nombreTarea=tareas[i].name;if(tareas[i].name=="edicion")tareas[i].ref=eval("tarea_"+nombreTarea+"=new Tarea_"+nombreTarea+"();");else tareas[i].ref=eval("tarea_"+nombreTarea+"=new tarea_"+nombreTarea+"();");tareas[i].init=true;if(tareas[i].name=="tematicos"&&tematicoIdInicio!=null)
tarea_tematicos.tematicoInicio=tematicoIdInicio;}catch(e){console.error("Error inicializado tarea: "+nombreTarea);tareas[i].init=false;}}}else console.warn("tareasInit: Ninguna tarea definida.");}catch(e){alert("Error a tareasInit()\n"+e.message);}}
function createLayerWMS(codigo,url,layers,layerUrlParams,layerParams){var urlParams={service:"WMS",request:"GetMap",layers:layers,exceptions:null};for(param in layerUrlParams)urlParams[param]=(layerUrlParams[param]==null)?'':layerUrlParams[param];if(typeof(layerParams.opacity)!="undefined")layerParams.opacity=parseFloat(layerParams.opacity);console.log("layer WMS layerParams",layerParams);return new OpenLayers.Layer.WMS(codigo,url,urlParams,layerParams);}
function createLayerTC(codigo,url,layers,layerUrlParams,layerParams){var urlParams={service:"WMS",request:"GetMap",layers:layers,exceptions:null};var bounds=new OpenLayers.Bounds(parseFloat(layerParams["maxExtentX0"]),parseFloat(layerParams["maxExtentY0"]),parseFloat(layerParams["maxExtentX1"]),parseFloat(layerParams["maxExtentY1"]));layerParams.maxExtent=bounds;layerParams.singleTile=false;if(typeof(layerParams.buffer)!="undefined")layerParams.buffer=parseInt(layerParams.buffer);console.log("layer TC layerParams",layerParams);for(param in layerUrlParams)urlParams[param]=(layerUrlParams[param]==null)?'':layerUrlParams[param];return new OpenLayers.Layer.WMS(codigo,url,urlParams,layerParams);}
function createLayerTILECACHE(codigo,url,layers,layerUrlParams,layerParams){var tileSizeValue=parseFloat(layerParams["tileSize"]);if(isNaN(tileSizeValue)){tileSizeValue=256;console.error("Layer TileCache sin el parámetro tileSize. Revisa la configuración.");}
var tileSize=new OpenLayers.Size(parseFloat(layerParams["tileSize"]),parseFloat(layerParams["tileSize"]));layerParams.tileSize=tileSize;layerParams.serverResolutions=map.resolutions;var x0=parseFloat(layerParams["tileExtentX0"]);var y0=parseFloat(layerParams["tileExtentY0"]);var x1=parseFloat(layerParams["tileExtentX1"]);var y1=parseFloat(layerParams["tileExtentY1"]);if(!isNaN(x0)&&!isNaN(y0)&&!isNaN(x1)&&!isNaN(y1))layerParams.maxExtent=new OpenLayers.Bounds(x0,y0,x1,y1);layerParams.singleTile=false;if(layerParams.buffer)layerParams.buffer=parseInt(layerParams.buffer);console.log("layer TILECACHE layerParams",layerParams);for(param in layerUrlParams)urlParams[param]=(layerUrlParams[param]==null)?'':layerUrlParams[param];return new OpenLayers.Layer.TileCache(codigo,url,layers,layerParams);}
function createLayerARCGISCACHE(codigo,url,layers,layerUrlParams,layerParams){if(layerParams["tileOriginX"]==null||layerParams["tileOriginY"]==null||layerParams["type"]==null)
console.error("Error en la definición del layer de ARCGISCACHE con código='"+codigo+"'. Revisa los parámetros del servicio.");var agsTileOrigin=new OpenLayers.LonLat(parseFloat(layerParams["tileOriginX"]),parseFloat(layerParams["tileOriginY"]));var x0=parseFloat(layerParams["tileExtentX0"]);var y0=parseFloat(layerParams["tileExtentY0"]);var x1=parseFloat(layerParams["tileExtentX1"]);var y1=parseFloat(layerParams["tileExtentY1"]);var layerP={tileOrigin:agsTileOrigin,resolutions:map.resolutions,sphericalMercator:false,maxExtent:map.getMaxExtent(),useArcGISServer:false,isBaseLayer:false,type:layerParams["type"]};if(!isNaN(x0)&&!isNaN(y0)&&!isNaN(x1)&&!isNaN(y1))layerP.maxExtent=new OpenLayers.Bounds(x0,y0,x1,y1);return new OpenLayers.Layer.ArcGISCache(codigo,url+layers,layerP);}
function createLayerWFS(codigo,url,layers,layerUrlParams,layerParams,cartografia,addToMap){console.log("createLayerWFS");var geometryName="";var featureNS="";geometryName=typeof(layerParams["gn_"+layers])!="undefined"?layerParams["gn_"+layers]:"";featureNS=typeof(layerParams["fns_"+layers])!="undefined"?layerParams["fns_"+layers]:"";if(geometryName==""||featureNS==""){ConfigManager.getDescriptionFeature(url,layers,function(json){try{var data=dojo.fromJson(json);console.log("El json con el describeFeatureContainer=",data);if(typeof(data.featureNS)!="undefined")featureNS=data.featureNS;for(var i=0;i<data.items.length;i++){if(data.items[i].type.indexOf("gml:")==0){geometryName=data.items[i].name;var l=crearLayerDescrito(codigo,url,layers,layerUrlParams,layerParams,featureNS,geometryName);l.carNombre=cartografia.carNombre;l.order=cartografia.carOrden;map.addLayer(l);raiseLayerOrder(l);if(l.CLASS_NAME=="OpenLayers.Layer.Vector"){l.redraw();}
break;}}}
catch(e){window.top.console.log("error",e);}});return null;}
var l=crearLayerDescrito(codigo,url,layers,layerUrlParams,layerParams,featureNS,geometryName);return l;}
function crearLayerDescrito(codigo,url,layers,layerUrlParams,layerParams,featureNS,geometryName){var styleMap;var layer=layers.indexOf(":")>=0?layers.substring(layers.indexOf(":")+1):layers;var prefix=layers.indexOf(":")>=0?layers.substring(0,layers.indexOf(":")):layers;var renderer=OpenLayers.Util.getParameters(window.location.href).renderer;renderer=(renderer)?[renderer]:OpenLayers.Layer.Vector.prototype.renderers;var l=new OpenLayers.Layer.Vector(codigo,{strategies:[new OpenLayers.Strategy.BBOX()],protocol:new OpenLayers.Protocol.WFS({url:url,featureType:layer,featurePrefix:prefix,featureNS:featureNS,geometryName:geometryName,maxFeatures:layerUrlParams.MAXFEATURES}),renderers:renderer,projection:new OpenLayers.Projection(layerParams.projection)});if(typeof(layerUrlParams.STYLES)!="undefined"){styleMap=getVectorStyles(layerUrlParams.STYLES);l.styleMap=styleMap;}
else if(typeof(sitmunProperties["wfs.estilo."+codigo+".strokeWidth"])!="undefined"){styleMap=getVectorStyles("wfs.estilo."+codigo);l.styleMap=styleMap;}
return l;}
function createLayerGML(codigo,url,layers,layerUrlParams,layerParams){console.log("createLayerGML");var layer=new OpenLayers.Layer.Vector(codigo,{strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:url,format:new OpenLayers.Format.GML({gmlns:"*"})})});styleMap=getVectorStyles("capas.estilo.gml");layer.styleMap=styleMap;return layer;}
function createLayerKML(codigo,url,layers,layerUrlParams,layerParams){console.log("createLayerKML");var layer=new OpenLayers.Layer.Vector(codigo,{strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:url,format:new OpenLayers.Format.KML({extractStyles:true,extractAttributes:false,maxDepth:0,internalProjection:new OpenLayers.Projection(map.projection)})})});return layer;};function createLayerGEOJSON(codigo,url,layers,layerUrlParams,layerParams){console.log("createLayerGeoJSON");var layer=new OpenLayers.Layer.Vector(codigo,{strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:url,format:new OpenLayers.Format.GeoJSON()})});return layer;}
function createLayerGEORSS(codigo,url,layers,layerUrlParams,layerParams){console.log("createLayerGeoRSS");var layer=new OpenLayers.Layer.GeoRSS(codigo,url,{useFeedTitle:false,projection:new OpenLayers.Projection("EPSG:4326"),icon:new OpenLayers.Icon("img/poi.gif",new OpenLayers.Size(32,32))});return layer;}
function createLayerGEOMAPA(codigo,url,layers,layerUrlParams,layerParams){console.log("createLayerKML");var myStyles=new OpenLayers.StyleMap({"default":new OpenLayers.Style({externalGraphic:"http://www.geomapa.cat/images/gm-icones/"+layers+".png",graphicWidth:27,graphicHeight:27}),"temporary":new OpenLayers.Style({externalGraphic:"http://www.geomapa.cat/images/gm-icones/"+layers+".png",graphicWidth:27,graphicHeight:27}),"selected":new OpenLayers.Style({externalGraphic:"http://www.geomapa.cat/images/gm-icones/"+layers+".png",graphicWidth:27,graphicHeight:27})});var layer=new OpenLayers.Layer.Vector(codigo,{strategies:[new OpenLayers.Strategy.Fixed()],styleMap:myStyles,protocol:new OpenLayers.Protocol.HTTP({url:url+layers,format:new OpenLayers.Format.KML({extractStyles:false,extractAttributes:true,maxDepth:1,internalProjection:new OpenLayers.Projection(map.projection)})})});layer.events.register("moveend",layer,onKMLMoveEnd);return layer;};function onKMLMoveEnd(event){console.log("onKMLMoveEnd");if(!this.eventsAfegits){console.log("onKMLMoveEnd: afegim events...");var report=function(e){console.log("REPORT: ",e);};var onKMLFeatureSelect=function(event){console.log(onKMLFeatureSelect);var feature=event.feature;var content="<h3>"+feature.attributes.name+"</h3>"+feature.attributes.description;var popup=new OpenLayers.Popup.FramedCloud("GeomapaPopup",feature.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(100,100),content,null,true);feature.popup=popup;map.addPopup(popup);};var onKMLPopupClose=function(event){select.unselectAll();};var onKMLFeatureUnselect=function(event){var feature=event.feature;if(feature.popup){map.removePopup(feature.popup);feature.popup.destroy();delete feature.popup;}};var onLayerRemoved=function(e){try{console.log("onLayerRemoved");this.events.unregister("featureselected",this,onKMLFeatureSelect);this.events.unregister("featureunselected",this,onKMLFeatureUnselect);var selectCtrl=map.getControlsBy("name","selectCtrlGeomapa"+this.name);if(selectCtrl.length>0){map.removeControl(selectCtrl[0]);selectCtrl[0].destroy();}}catch(e){console.warn("Error eliminando layer de GEOMAPA",e);}};this.events.register("featureselected",this,onKMLFeatureSelect);this.events.register("featureunselected",this,onKMLFeatureUnselect);this.map.events.register("removelayer",this,onLayerRemoved);var selectCtrl=new OpenLayers.Control.SelectFeature(this,{name:"selectCtrlGeomapa"+this.name,clickout:true});map.addControl(selectCtrl);selectCtrl.activate();this.eventsAfegits=true;this.events.unregister("moveend",this,onKMLMoveEnd);}}